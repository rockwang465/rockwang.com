apiVersion: kubeadm.k8s.io/v1beta1
kind: InitConfiguration
localAPIEndpoint:
  advertiseAddress: "{{ ansible_host | default(ansible_default_ipv4.address) }}"
  bindPort: 6443
nodeRegistration:
{% if kube_override_hostname|default('') %}
  name: {{ kube_override_hostname }}
{% endif %}
{% if kube_master_noschedule and inventory_hostname in groups['kube-master'] and inventory_hostname not in groups['kube-node'] %}
  taints:
  - effect: NoSchedule
    key: node-role.kubernetes.io/master
{% endif %}
  kubeletExtraArgs:
    cgroup-driver: "{{ docker_cgroup_driver }}"
---
apiVersion: kubeadm.k8s.io/v1beta1
kind: ClusterConfiguration
# etcd:
#   external:
#       endpoints:
# {% for endpoint in etcd_access_addresses.split(',') %}
#       - {{ endpoint }}
# {% endfor %}
#       caFile: {{ etcd_cert_dir }}/ca.pem
#       certFile: {{ etcd_cert_dir }}/node-{{ inventory_hostname }}.pem
#       keyFile: {{ etcd_cert_dir }}/node-{{ inventory_hostname }}-key.pem
networking:
  dnsDomain: {{ dns_domain }}
  serviceSubnet: {{ kube_service_subnet }}
  podSubnet: {{ kube_pod_subnet }}
kubernetesVersion: "{{ kube_version }}"
{% if kube_api_loadbalancer is defined %}
controlPlaneEndpoint: {{ kube_api_loadbalancer.domain }}:6443
{% else %}
controlPlaneEndpoint: {{ ansible_host | default(ansible_default_ipv4.address) }}:6443
{% endif %}
clusterName: {{ cluster_name }}
certificatesDir: {{ kube_cert_dir }}
imageRepository: {{ kube_image_repo }}
useHyperKubeImage: false
apiServer:
  certSANs:
{% if kube_api_loadbalancer is defined %}
  - {{ kube_api_loadbalancer.domain }}
  - {{ kube_api_loadbalancer.ip }}
{% endif %}
{% for item in groups['kube-master'] %}
  - {{ item }}
  - {{ hostvars[item]['access_ip'] | default(hostvars[item]['ip'] | default(hostvars[item]['ansible_host'])) }}
{% endfor %}
---
apiVersion: kubeproxy.config.k8s.io/v1alpha1
kind: KubeProxyConfiguration
ipvs:
  excludeCIDRs:
{% for item in kube_proxy_exclude_cidrs %}
  - {{ item }}
{% endfor %}
  minSyncPeriod: {{ kube_proxy_min_sync_period }}
  scheduler: {{ kube_proxy_scheduler }}
  syncPeriod: {{ kube_proxy_sync_period }}
